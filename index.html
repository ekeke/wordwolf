<html lang="ja">
<head>
  <title>ワードウルフ.com</title>
  <meta name="keywords" content="ワードウルフ,人狼,パーティーゲーム" />
  <meta name="description" content="ワードウルフが遊べるサイトです。" />
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="styles.css" />
</head>
<body>


<section id="how-to-play" class="js-page" style="display: none">
  <h1>word-wolf.com</h1>
  <h2>遊び方</h2>
  <p>ワードウルフは、村人陣営と狼陣営に分かれてお互いのキーワードを推理するパーティーゲームです。</p>
  <p>プレイヤーは、少数派の人狼チームと多数派の村人チームにランダムに分けられます。人狼チームの目的は生き残ること。村人チームの目的は、人狼を追放することです。ただし、各プレイヤーは自分がどちらの陣営に所属しているのかは知らされません。</p>
  <p>次に、各陣営にそれぞれ共通のキーワードが配られます。</p>
  <p>キーワードが配られたら、全員でそのキーワードについて会話（議論）をします。キーワードに関連する会話をしながら、自分が村人なのか人狼なのか、誰を追放するべきか推理をしていきます。</p>
  <p>議論が終了したら、投票を行い追放する相手を決定します。村人を追放してしまったり、最多得票者が複数出てしまった場合、追放失敗となり村人チームの負けとなります。</p>
  <p>人狼を追放することに成功しても油断は出来ません。人狼は追放された後に、村人のキーワードを的中することで逆転勝利ができます。会話の中で出たヒントから、村人陣営のキーワードを推理して答えてください。</p>
  <p>人狼が村人チームのキーワードを的中した場合、村人チームの負けとなります。的中できなかった場合、はじめて村人チームの勝利となります。</p>
  <a href="#" id="to-config-village" class="next-button">ゲームをはじめる</a>
</section>



<section id="config-village" class="js-page" style="display: none">
  <h1>参加者の設定</h1>
  <ul id="player-list">

    <!-- こんなのがjsで挿入されるらしいよ
      <li class="player-holder">
        <input type="text" class="js-player-name" data-player-id="2" value="えけけ"/>
        <a href="#" class="delete-player action-button" data-player-id="2">削除</a>
      </li>
    -->

  </ul>
  <div><a href="#" id="add-more-player" class="action-button">プレイヤーを追加</a></div>
  <div><a href="#" id="reset-players" class="action-button">プレイヤーとスコアを初期化</a></div>
  <div>
      <label for="wolves">人狼の人数</label>
      <a href="#" class="change-wolves-num" data-num="-1">◀</a>
      <input type="number" id="wolves" readonly="readonly" value="1" />
      <a href="#" class="change-wolves-num" data-num="+1">▶</a>
  </div>

  <a href="#" id="to-config-wordpair" class="next-button">次へ</a>
</section>


<section id="config-wordpair" class="js-page" style="display: none">
  <h1>ゲームマスターの設定</h1>
  <div>ゲームマスター（GM）を一人選んでください（GMは試合には参加できません）</div>
  <div><select id="game-master"></select></div>
  <div>GMは村ワードと狼ワードを考え、入力してください。
組み合わせがわかりやすすぎるもの（例；珈琲と紅茶）や、関連性が薄すぎるもの（例；珈琲と富士山）は避け、接戦となるようなワードの組み合わせを考えましょう。
  <ul>
    <li><label>村ワード<input type="text" id="villagerWord" value="リンゴ" /></label></li>
    <li><label>狼ワード<input type="text" id="wolfWord" value="みかん" /></label></li>
  </ul>
  </div>
  <a href="#" id="to-tell-words" class="next-button">次へ</a>
</section>



<section id="tell-words" class="js-page" style="display: none">
  <h1>ワードの確認</h1>
  <span id="player-name-to-tell" class="player-name"></span>さんにワードをお知らせします。
  あなたのワードは<div id="word-placeholder"><a href="#" id="open-word">？？？</a><span id="the-word"></span></div>です。
  <div>
    <a href="#" id="accept-word" class="next-button">確認しました</a>
  </div>
</section>


<section id="playing" class="js-page" style="display: none">
  <h1>議論の時間です</h1>
  議論を行ってください
  <div id="timer-wrapper">
    <div id="seconds">180</div>
    <a href="#" id="add-30-seconds" class="action-button">議論を30秒延長する</a>
  </div>
  <a href="#" id="finish-discussion" class="next-button">議論を終了する</a>
</section>



<section id="vote" class="js-page" style="display: none">
  <h1>投票の時間です</h1>
  <span id="voter-name" class="player-name"></span>さん、投票を行ってください
  <ul id="select-candidate">

    <!--  jsでこんなのが追加されます
      <li href="#" data-candidate-id="2" class="vote-to next-button">プレイヤー名</li>
    -->
  </ul>
</section>


<section id="result-no-banish" class="js-page" style="display: none">
  <h1>追放</h1>
  同票により、誰も追放されませんでした。
  <a href="#" class="to-result next-button">結果を表示</a>
</section>


<section id="result-villager-banished" class="js-page" style="display: none">
  <h1>追放</h1>
  追放された<span class="banished-person-name player-name"></span>さんは村人でした。
  <a href="#" class="to-result next-button">結果を表示</a>
</section>


<section id="result-wolf-banished" class="js-page" style="display: none">
  <h1>追放</h1>
  追放された<span class="banished-person-name player-name"></span>さんは人狼でした。
  <section>
  <span class="banished-person-name"></span>さんは、村ワードを当てることで逆転勝利ができます。推理した村ワードを発表し、GMは答え合わせを行ってください(複雑なワードの場合、多少の揺れは許容してくださいね)。
  </section>
  <h2>結果を入力</h2>
  <a href="#" id="finally-wolves-win" class="next-button">逆転勝利に成功</a>
  <a href="#" id="finally-wolves-lose" class="next-button">逆転勝利に失敗</a>
</section>


<section id="result" class="js-page" style="display: none">
  <h1>結果</h1>
  <h2>投票結果</h2>
  <table id="js-vote-result">
  </table>
  <h2>ポイント <a href="#" id="to-point-help">?</a></h2>
  <table id="js-point-result">
  </table>
  <h2>ワードの答え</h2>
  <table>
    <tr>
      <th>村ワード</th>
      <td id="answer-villager-word"></td>
    </tr>
    <tr>
      <th>狼ワード</th>
      <td id="answer-wolf-word"></td>
    </tr>
  </table>
  <div id="post-form">
    <div id="post-wordpair-wrapper">
      <h2>word-wolf.comに問題を投稿</h2>
      <p>
        word-wolf.comでは、おもしろいワード人狼の問題を収集しています。
      </p>
      <h4>難しさ</h4>
      <input type="radio" name="estimate-difficulty" class="estimate difficulty" value="-1" id="difficulty-down" /><label for="difficulty-down">易しい</label>
      <input type="radio" name="estimate-difficulty" class="estimate difficulty estimate-default" value="0" id="difficulty-keep" checked="checked" /><label for="difficulty-keep">ふつう</label>
      <input type="radio" name="estimate-difficulty" class="estimate difficulty" value="1" id="difficulty-up" /><label for="difficulty-up">難しい</label>

      <h3>対象年齢</h3>
      <input type="radio" name="estimate-age" class="estimate age" value="-1" id="age-down" /><label for="age-down">こどもむけ</label>
      <input type="radio" name="estimate-age" class="estimate age estimate-default" value="0" id="age-keep" checked="checked" /><label for="age-keep">ふつう</label>
      <input type="radio" name="estimate-age" class="estimate age" value="1" id="age-up" /><label for="age-up">おとなむけ</label>
      <div>
      <p class="attention">個人名などの個人情報や公序良俗に反する表現の投稿はご遠慮ください。</p>
      <a href="#" id="post-wordpair" class="action-button">投稿する</a>
      </div>
    </div>
    <div id="post-wordpair-thanks-wrapper">
      <span id="post-wordpair-thanks">投稿ありがとうございました!</span>
    </div>
  </div>

  <a href="#" id="next-game" class="next-button">次の村へ</a>
</section>


<section id="point-help" class="js-page" style="display: none">
  <table>
    <tr>
      <td></td>
      <th>追放なし  </th>
      <th>村人を追放</th>
      <th>人狼を追放</th>
      <th>人狼の逆転</th>
    </tr>
    <tr>
      <th>村人チーム</th>
      <td>-1</td>
      <td>-1</td>
      <td>+2</td>
      <td>-2</td>
    </tr>
    <tr>
      <th>GM</th>
      <td>+1</td>
      <td>+1</td>
      <td>-3</td>
      <td>-3</td>
    </tr>
    <tr>
      <th>人狼チーム</th>
      <td colspan="4">(村人チームの点数x村人の人数＋GMの点数)/人狼の人数</td>
    </tr>
  </table>
  <a href="#" id="back-to-result" class="next-button">結果画面に戻る</a>
</section>


<script src="https://code.jquery.com/jquery-2.2.0.min.js"></script>
<script src="game.js"></script>
<script>

$('#to-point-help').click( function () {
  showPage('point-help');
});

$('#back-to-result').click( function () {
  showPage('result');
});

var playerId;
var players = new Players();
players.load();
for ( var id in players.member ) {
  addPlayer(id,players.member[id].name);
}
var numPlayers = players.count();
if ( 4 < numPlayers ) {
  $('.delete-player').show();
}
var village;
window.onunload = function () {
  players.save();
};

$('#to-config-wordpair').click( function () {
  var $select = $('#game-master');
  $select.empty();
  for ( var id in players.member ) {
    var player = players.member[id];
    $('<option />').text( player.name ).addClass('gm-select-option').attr('data-player-id', id ).appendTo($select);
  }
  showPage('config-wordpair');
});

$('#to-tell-words').click( function () {
  var masterId = $('.gm-select-option:selected').attr('data-player-id');
  village = new Village(
    players,
    parseInt($('#wolves').val()),
    $('#villagerWord').val(),
    $('#wolfWord').val(),
    masterId
  );
  setNextWord();
  showPage('tell-words');
});

$('#accept-word').click( acceptWord );

$('#finish-discussion').click( function () {
  prepareVote();
  showPage('vote');
});

var voter;
function prepareVote() {
  voter = village.prepareVote();
  if ( !voter ) return false;
  $('#voter-name').text(voter.voter.name);
  var $candidates = $('#select-candidate').empty();
  for ( var i = 0; i < voter.candidates.length; i++ ) {
    var candidate = voter.candidates[i];
    $('<li />')
      .attr('href', '#')
      .attr('data-candidate-id', candidate.id)
      .text(candidate.name)
      .addClass('vote-to')
      .addClass('next-button')
      .appendTo($candidates)
    ;
  }
  return true;
}

$(document).on('click', '.vote-to', function () {
  var candidateId = $(this).attr('data-candidate-id');
  var candidateName = $(this).text();
  if ( !window.confirm(candidateName + "さんに投票します。よろしいですか？") ) {
    return false;
  };
  village.vote(voter.voter.id, candidateId);
  if ( !prepareVote() ) {
    var res = village.judge();
    if ( !res ) {
      showPage('result-no-banish');
    }
    else {
      $('.banished-person-name').text(res.name);
      if ( res.role === 'villager' ) {
        showPage('result-villager-banished');
      }
      else {
        showPage('result-wolf-banished');
      }
    }
  }
});

$('#show-results').click( function () {
  $('#result-list').show();
});

$('#next-game').click(function () {
  showPage('config-village');
});

function showPage (page) {
  $('.js-page').hide();
  if ( page === 'result' ) {
    buildResult();
  }
  $('#' + page).show();
}

function buildResult () {
  var $voteTable = $('#js-vote-result').empty();
  var $pointTable = $('#js-point-result').empty();
  for ( var id in village.voteMap ) {
    var $row = $('<tr />');
    $('<td />').addClass('player-name').text( players.member[id].name ).appendTo($row);
    $('<td />').text( '→' ).appendTo($row);
    $('<td />').addClass('player-name').text( players.member[village.voteMap[id]].name ).appendTo($row);
    $row.appendTo($voteTable);
  }

  var roleTrans = {
    wolf: '人狼',
    master: 'GM',
    villager: '村人'
  };
  var $row = $('<tr />');
  $('<th />').text('名前').appendTo($row);
  $('<th />').text('役職').appendTo($row);
  $('<th />').text('結果').appendTo($row);
  $('<th />').text('累積').appendTo($row);
  $row.appendTo($pointTable);

  for ( var id in village.scoreMove ) {
    var $row = $('<tr />');
    $('<td />').addClass('player-name').text( players.member[id].name ).appendTo($row);
    $('<td />').text( roleTrans[players.member[id].role] ).appendTo($row);
    $('<td />').text( village.scoreMove[id] ).appendTo($row);
    $('<td />').addClass('player-name').text( players.member[id].point ).appendTo($row);
    $row.appendTo($pointTable);
  }

  $('#answer-villager-word').text(village.villagerWord);
  $('#answer-wolf-word').text(village.wolfWord);

  $('#post-wordpair-wrapper').show();
  $('#post-wordpair-thanks-wrapper').hide();

  $('.estimate').removeAttr('checked');
  $('.estimate-default').prop('checked', 'checked');
}

function addPlayer(id,name) {
  $('<li class="player-holder"><input type="text" class="js-player-name" data-player-id="' + id + '" value="' + name +'"/><a href="#" class="delete-player action-button" data-player-id="' + id + '" style="display: none;">削除</a></li>').appendTo('#player-list');
  return false;
}

$('#add-more-player').on('click', function () {
  var id = players.maxId() + 1;
  var name = 'プレイヤー' + (id+1);
  addPlayer(id, name);
  players.add(name,id);
  $('.delete-player').show();
});

$(document).on('change', '.js-player-name', function () {
  var id = $(this).attr('data-player-id');
  players.member[id].name = $(this).val();
});

$(document).on('click', '.delete-player', function () {
  var id = $(this).attr('data-player-id');
  players.remove(id);
  $(this).parents('li.player-holder').remove();
  if ( $('.player-holder').length <= 4 ) {
    $('.delete-player').hide();
  }

  var current = parseInt($('#wolves').val());
  if ( current <= 0 ) {
    current = 1;
  }
  var numPlayers = $('.js-player-name').length;
  var max_wolves = parseInt((numPlayers - 1)/2);
  if ( max_wolves < current ) {
    current = max_wolves;
  }
  $('#wolves').val(current);

});

$('.change-wolves-num').click(function () {
  var current = parseInt($('#wolves').val());
  var change = parseInt($(this).attr('data-num'));
  current += change;
  if ( current <= 0 ) {
    current = 1;
  }
  var players = $('.js-player-name').length;
  var max_wolves = parseInt((players - 1)/2);
  if ( max_wolves < current ) {
    current = max_wolves;
  }

  $('#wolves').val(current);
  return false;
});

function setNextWord () {
  var player = village.tellWord();
  if ( !player ) return false;

  $('#open-word').show();
  $('#player-name-to-tell').text(player.name);
  $('#the-word').text( player.word ).hide();
  $('#accept-word').hide();
  return true;
}

$('#open-word').click( openWord );

function openWord () {
  $('#open-word').hide();
  $('#the-word').show();
  $('#accept-word').show();
  return false;
}

function acceptWord () {
  if ( !setNextWord() ) {
    startTimer();
    showPage('playing');
  }
  return false;
}

$('#finally-wolves-win').click( function () {
  village.wolfRevenge(true);
  showPage('result');
});

$('#finally-wolves-lose').click( function () {
  village.wolfRevenge(false);
  showPage('result');
});

$('.to-result').click( function () {
  showPage('result');
});

var targetTime;
function startTimer(seconds) {
  var now = (new Date()).getTime();
  targetTime = now + (seconds || 300000);
  $('#seconds').text( targetTime - now );
}

$('#add-30-seconds').click(function () {
  targetTime += 30000;
});

setInterval(function () {
  if ( !targetTime ) return;
  var now = (new Date()).getTime();
  if ( targetTime > now ) {
    $('#seconds').text( parseInt((targetTime - now)/1000) );
  }
},100);

$('#reset-players').click( function () {
  if ( confirm('プレイヤー名と累積スコアを消去します。よろしいですか？') ) {
    localStorage.players = '{"0":{"name":"プレイヤー1","point":0},"1":{"name":"プレイヤー2","point":0},"2":{"name":"プレイヤー3","point":0},"3":{"name":"プレイヤー4","point":0}}';
    players.load();
    $('#player-list').empty();
    for ( var id in players.member ) {
      addPlayer(id,players.member[id].name);
    }
    var numPlayers = players.count();
    if ( 4 < numPlayers ) {
      $('.delete-player').show();
    }
  }
});

$('#to-config-village').click(function () {
  showPage('config-village');
});
showPage('how-to-play');

// Communicate with server
$('#post-wordpair').click(function () {
  $('#post-wordpair-wrapper').hide();
  $('#post-wordpair-thanks-wrapper').show();
  $.ajax({
    data: JSON.stringify({
      ww: village.wolfWord,
      vw: village.villagerWord,
      result: village.result,
      difficulty: $('.estimate.difficulty:checked').val(),
      age: $('.estimate.age:checked').val(),
    }),
    method: 'POST',
    url: 'wordpairs'
  });

});

</script>
</body>
</html>
